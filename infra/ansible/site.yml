---
- name: TP - Déploiement local de l'application
  hosts: local
  gather_facts: false

  vars:
    app_image: "tp-app:latest"
    http_port: "8080"
    app_port: "5000"
    network_name: "app_network"
    app_env: "production"

  tasks:
    - name: Vérifier que Docker est disponible
      ansible.builtin.command: docker --version
      register: docker_version
      changed_when: false

    - name: Afficher la version de Docker
      ansible.builtin.debug:
        var: docker_version.stdout

    - name: Créer le réseau Docker
      community.docker.docker_network:
        name: "{{ network_name }}"
        state: present

    - name: Déployer le conteneur de l'application Flask
      community.docker.docker_container:
        name: flask_app
        image: "{{ app_image }}"
        state: started
        restart_policy: unless-stopped
        ports:
          - "{{ app_port }}:{{ app_port }}"
        networks:
          - name: "{{ network_name }}"
        env:
          PORT: "{{ app_port }}"
          APP_ENV: "{{ app_env }}"
        pull: false

    - name: Déployer le conteneur Nginx (reverse proxy)
      community.docker.docker_container:
        name: nginx_proxy
        image: nginx:alpine
        state: started
        restart_policy: unless-stopped
        ports:
          - "{{ http_port }}:80"   # <- exposition correcte
        networks:
          - name: "{{ network_name }}"
        volumes:
          - "./nginx.conf:/etc/nginx/conf.d/default.conf"
        pull: true

    - name: Vérification post-déploiement
      ansible.builtin.uri:
        url: "http://localhost:{{ http_port }}/health"
        method: GET
        status_code: 200
      register: health_check
      until: health_check.status == 200
      retries: 5
      delay: 10

    - name: Afficher un message de succès
      ansible.builtin.debug:
        msg: "Déploiement réussi ! L'application est accessible à l'adresse http://localhost:{{ http_port }}"
      when: health_check.status == 200
